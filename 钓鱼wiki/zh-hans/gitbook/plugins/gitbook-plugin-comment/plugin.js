require(["gitbook","jQuery","lodash"],function(t,n,e){function o(n){var e=t.state.$book.find(".page-wrapper"),o=e.find(".page-inner"),a=t.state.$book.find(".navigation.navigation-next");if(e.toggleClass("comments-open",n),e.hasClass("comments-open")){var i=330,c=o.width(),s=e.width(),r=0==a.length?0:a.width(),m=(s-c)/2-r,l=m-i;l=Math.max(l,-i),l=Math.min(l,0),o.css("left",l+"px")}else o.css("left","0px")}function a(n){return(t.state.bookRoot+"/gitbook/api/"+n).replace(/([^:]\/)\/+/g,"$1")}function i(){location.href=a("login")}function c(t){var n=window.open(t,"_blank");n.focus()}function s(t,e,o,i){n.ajax({method:t,dataType:"json",url:a(e),data:o,success:function(t,n,e){L=!0,G=!!e.getResponseHeader("X-GitBook-Auth"),i(t)},error:function(t,n){L&&(alert("Error processing comments: "+n),console.log(t,n))}})}function r(){return t.state.innerLanguage?[t.state.innerLanguage,t.state.filepath].join("/"):t.state.filepath}function m(){s("GET","discussions",{filename:r(),state:"open"},function(t){O=t.list,$()})}function l(t){s("GET","discussions/"+t+"/comments",{limit:B},function(n){E[t]=n,j(t)})}function u(n,e,o,a){s("POST","discussions",{title:n,body:e,context:{filename:r(),chapterTitle:t.state.chapterTitle,section:o}},a)}function p(t){O=e.reject(O,{number:t}),$(),s("POST","discussions/"+t,{state:"closed"},function(){m()})}function d(t,n,e){s("POST","discussions/"+t+"/comments",{body:n},function(n){E[t]=E[t]||[],E[t].total=E[t].total+1,E[t].list.push(n),j(t),l(t),e(n)})}function f(t){var n=t.split(" ");return e.chain(O).map(function(t){var o=(t.context.section||"").split(" "),a=e.filter(o,function(t){return e.contains(n,t)}),i=e.filter(n,function(t){return e.contains(o,t)}),c=(a.length/o.length+i.length/n.length)/2;return{matching:c,thread:t}}).filter(function(t){return t.matching>.8}).sortBy("matching").pluck("thread").value()}function h(t){return t.clone().find(".comments-area,.comments-icon").remove().end().text()}function v(t,e){console.log(h(e));var o,a,c=n("<div>",{"class":"comments-post"});if(G){o=n("<input>",{type:"text",placeholder:"Start a new discussion"}),a=n("<input>",{type:"text",placeholder:"Optional comment"});var s=k([{text:"Post",click:function(){u(o.val(),a.val(),h(e),function(n){O.push(n),$(),y(t,e,n)})}}]);a.hide(),o.keyup(function(t){o.val().length>3?a.show():a.val()||a.hide()}),c.append(o),c.append(a),c.append(s)}else{var s=k([{text:"Sign in to comment",click:i}]);c.append(s)}t.empty(),t.append(c),o&&o.focus()}function g(t){return n("<div>",{"class":"thread",html:R({thread:t})})}function b(t,e){return n("<div>",{"class":"comment",html:N({comment:t})})}function k(t){var o=n("<div>",{"class":"comments-toolbar"});return e.each(t,function(t){var e=n("<a>",{href:"#",text:t.text,click:function(n){n.preventDefault(),t.click()}});e.appendTo(o)}),o}function x(t,e){t.empty();var o=n("<input>",{type:"text",placeholder:"Leave a comment"}),a=k([{text:"Post",click:function(){d(e.number,o.val(),function(){o.val("")})}}]);t.append(o),t.append(a),o.focus()}function y(t,e,o,a){l(o.number);var c=[];G?(o.permissions.comment&&c.push({text:"Comment",click:function(){x(s,o)}}),o.permissions.close&&c.push({text:"Close",click:function(){T(e,a),p(o.number)}}),c.push({text:"New Thread",click:function(){v(t,e)}})):c=[{text:"Sign in to comment",click:i}];var s=n("<div>",{"class":"comments-post"});s.append(k(c));var r=n("<div>",{"class":"comments-list","data-thcomments":o.number});t.empty(),t.append(b(o)),t.append(r),t.append(s),j(o.number)}function w(t,o,a){var c=n("<div>",{"class":"comments-threads"});e.each(a,function(n){var e=g(n);e.click(function(e){y(t,o,n)}),c.append(e)});var s;s=k(G?[{text:"New Thread",click:function(){v(t,o)}}]:[{text:"Sign in to create a thread",click:i}]),t.empty(),t.append(c),t.append(s)}function C(){t.state.$book.find(".page-wrapper .comments-section").removeClass("has-comments-open")}function T(t,e){var a=!t.hasClass("has-comments-open");if(C(),t.toggleClass("has-comments-open",a),o(a),a){t.find(".comments-area").remove();var i=n("<div>",{"class":"comments-area"});t.append(i),e.length>1?w(i,t,e):1==e.length?y(i,t,e[0],e):v(i,t)}}function S(t){var o=h(t);if(!(o.length<5)){var a=f(o),i=e.reduce(a,function(t,n){return t+1+n.comments},0),c=n("<div>",{"class":"marker",text:i?i:"+"});c.on("click",function(){T(t,a)});var s=n("<div>",{"class":"comments-icon"});s.append(c),t.find(".comments-icon").remove(),t.addClass("comments-section"),t.toggleClass("has-comments",i>0),P.highlightCommented&&t.toggleClass("has-highlight-comments",i>0),t.append(s)}}function $(){var e=t.state.$book.find(".page-wrapper"),o=e.find(M);o.each(function(){S(n(this))})}function j(n){var o=e.find(O,{number:n});if(E[n]&&o){var a=t.state.$book.find('.page-wrapper div[data-thcomments="'+n+'"]');if(0!=a.length){a.empty();var i=Math.max(0,E[n].total-B);i>0&&a.append(k([{text:"View "+i+" more comments",click:function(){c(o.urls.details)}}])),e.chain(E[n].list||[]).reverse().each(function(t){a.append(b(t))}).value()}}}var P={},O=[],E={},G=!1,L=!1,M="p",B=4,N=e.template('<img src="<%- comment.user.urls.avatar %>" class="comment-avatar" /><div class="comment-body"><a href="<%- comment.user.urls.profile %>" target="_blank" class="comment-user"><%- comment.user.name %></a><div class="comment-content"><% if (comment.title) { %><%- comment.title %><% if (comment.body) { %><br/><% } %><% } %><%= comment.body || "" %></div></div>'),R=e.template('<div class="thread-body"><div class="thread-title"><%- thread.title %></div><div class="thread-user">#<%- thread.number %> posted by <%- thread.user.name %></div></div>');t.events.bind("start",function(t,n){P=n.comment||{}}),t.events.bind("page.change",function(){O=[],m()})});
